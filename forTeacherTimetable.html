<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œê°„í‘œ ì¡°íšŒ HTML ìƒì„±ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
        }
        #app-container {
            width: 100%;
            max-width: 600px;
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        #upload-box {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px 20px;
            margin-bottom: 30px;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #upload-box:hover {
            background-color: #e9ecef;
        }
        #upload-box p {
            margin: 0;
            font-size: 18px;
            color: #555;
        }
        #file-input {
            display: none;
        }
        .option-group {
            margin: 20px 0;
            text-align: left;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .option-group h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
            text-align: center;
        }
        .option-item {
            margin: 12px 0;
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        .option-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        .option-item label {
            cursor: pointer;
            color: #555;
        }

        /* ìƒ‰ìƒ í…Œë§ˆ ì„ íƒ ì„¹ì…˜ */
        .theme-section {
            margin: 20px 0;
            background-color: #f3e5f5;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ce93d8;
        }
        .theme-section h3 {
            margin: 0 0 15px 0;
            color: #7b1fa2;
            font-size: 16px;
            text-align: center;
        }
        .theme-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .theme-selector label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        .theme-selector select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }
        .theme-preview {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .theme-color {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #ddd;
            display: inline-block;
        }

        /* ë¡œê³  ì—…ë¡œë“œ ì„¹ì…˜ */
        .logo-upload-section {
            margin: 20px 0;
            background-color: #f0f7ff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #cce7ff;
        }
        .logo-upload-section h3 {
            margin: 0 0 15px 0;
            color: #1976d2;
            font-size: 16px;
            text-align: center;
        }
        .logo-upload-box {
            border: 2px dashed #2196f3;
            border-radius: 10px;
            padding: 20px;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .logo-upload-box:hover {
            background-color: #f8f9ff;
            border-color: #1976d2;
        }
        .logo-upload-box.uploaded {
            border-color: #4CAF50;
            background-color: #f1f8e9;
            border-style: solid;
        }
        .logo-preview-container {
            display: none;
            margin-bottom: 15px;
        }
        .logo-preview-container img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .logo-preview-container p {
            margin: 8px 0 0 0;
            font-size: 12px;
            color: #666;
        }
        .logo-upload-text {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        #logo-file-input {
            display: none;
        }

        /* ì œëª© ì…ë ¥ ì„¹ì…˜ */
        .title-input-section {
            margin: 20px 0;
            text-align: left;
            background-color: #fff8e1;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ffcc02;
        }
        .title-input-section h3 {
            margin: 0 0 15px 0;
            color: #f57c00;
            font-size: 16px;
            text-align: center;
        }
        .title-input-section label {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
            color: #333;
        }
        .title-input-section input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }

        #generate-button {
            display: none; /* ì´ˆë°˜ì—ëŠ” ìˆ¨ê¹€ */
            width: 100%;
            padding: 15px;
            border: none;
            background: linear-gradient(45deg, #28a745, #218838);
            color: white;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 15px;
        }
        #generate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.4);
        }
        #status {
            margin-top: 20px;
            font-size: 16px;
            color: #6c757d;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            body { 
                padding: 10px; 
                align-items: flex-start;
            }
            #app-container { 
                padding: 20px; 
                margin: 10px auto;
                max-width: 100%;
            }
            h1 { 
                font-size: 1.5em; 
                margin-bottom: 20px;
            }
            #upload-box { 
                padding: 30px 15px; 
            }
            #upload-box p { 
                font-size: 16px; 
            }
            .option-group, 
            .theme-section,
            .logo-upload-section, 
            .title-input-section { 
                padding: 15px; 
                margin: 15px 0;
            }
            .option-item { 
                font-size: 13px; 
            }
            .logo-upload-box { 
                padding: 15px; 
            }
            .logo-upload-text { 
                font-size: 13px; 
            }
            .title-input-section input {
                font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
            }
        }

        @media (max-width: 480px) {
            #app-container { 
                padding: 15px; 
            }
            h1 { 
                font-size: 1.3em; 
            }
            .option-group h3,
            .theme-section h3,
            .logo-upload-section h3,
            .title-input-section h3 { 
                font-size: 14px; 
            }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <h1>êµì‚¬ìš© ì‹œê°„í‘œ ì¡°íšŒ HTML ìƒì„±ê¸° ğŸš€</h1>

        <div id="upload-box">
            <p>ì£¼ê°„ì‹œê°„í‘œ íŒŒì¼ ì—…ë¡œë“œ<br> ì—¬ê¸°ë¥¼ í´ë¦­í•˜ê±°ë‚˜ <br>ì—‘ì…€ íŒŒì¼ ë“œë˜ê·¸í•˜ì—¬ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”.</p>
        </div>
        <input type="file" id="file-input" accept=".xlsx, .xls">

        <p id="status">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìƒì„± ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>

        <div class="option-group" id="options-group" style="display: none;">
            <h3>ğŸ“‹ í‘œì‹œ ì˜µì…˜ ì„¤ì •</h3>
            <div class="option-item" id="coloring-option-item" style="display: none;">
                <input type="checkbox" id="enable-coloring" name="enable-coloring" checked>
                <label for="enable-coloring">ì„ íƒë°˜(ì˜ˆ: A_ìˆ˜ì—…)ì„ ìƒ‰ìƒê³¼ ê¸°í˜¸ë¡œ êµ¬ë¶„í•˜ê¸°</label>
            </div>
            <div class="option-item" id="formatb-coloring-option-item" style="display: none;">
                <input type="checkbox" id="enable-formatb-coloring" name="enable-formatb-coloring" checked>
                <label for="enable-formatb-coloring">ì„ íƒê³¼ëª©ì„ ìƒ‰ìƒê³¼ ê¸°í˜¸ë¡œ êµ¬ë¶„í•˜ê¸° (ì˜ˆ: Aê³ ì „ì½ê¸°, English â†’ Aë°˜, Eë°˜ìœ¼ë¡œ í‘œì‹œ)</label>
            </div>
            <div class="option-item">
                <input type="checkbox" id="enable-line-break" name="enable-line-break" checked>
                <label for="enable-line-break">ìˆ˜ì—…ì¥ì†Œì™€ ìˆ˜ì—…ëª…ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ í‘œì‹œí•˜ê¸° (ì˜ˆ: 105 A_í™•í†µ â†’ 105<br>A_í™•í†µ)</label>
            </div>
            <div class="option-item">
                <input type="checkbox" id="enable-location-chip" name="enable-location-chip" checked>
                <label for="enable-location-chip">ìˆ˜ì—…ì¥ì†Œë¥¼ ì¹© í˜•íƒœë¡œ í‘œì‹œí•˜ê¸° (ë°˜ë§ˆë‹¤ ë‹¤ë¥¸ ìƒ‰ìƒ)</label>
            </div>
        </div>

        <div class="theme-section" id="theme-section" style="display: none;">
            <h3>ğŸ¨ ìƒ‰ìƒ í…Œë§ˆ ì„ íƒ</h3>
            <div class="theme-selector">
                <label for="color-theme">í…Œë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš”:</label>
                <select id="color-theme">
                    <option value="default">ê¸°ë³¸ (ë¸”ë£¨)</option>
                    <option value="dark">ë‹¤í¬ (ê²€ì •/íšŒìƒ‰)</option>
                    <option value="green">ê·¸ë¦° (ìì—°)</option>
                    <option value="purple">í¼í”Œ (ë³´ë¼)</option>
                    <option value="orange">ì˜¤ë Œì§€ (ë”°ëœ»í•¨)</option>
                    <option value="teal">í‹¸ (ë°”ë‹¤)</option>
                </select>
                <div class="theme-preview" id="theme-preview">
                    <span class="theme-color" style="background-color: #5A67D8;" title="ê¸°ë³¸ìƒ‰"></span>
                    <span class="theme-color" style="background-color: #7f8ff0;" title="ê°•ì¡°ìƒ‰"></span>
                    <span class="theme-color" style="background-color: #F7FAFC;" title="ë°°ê²½ìƒ‰"></span>
                </div>
            </div>
        </div>

        <div class="title-input-section" id="title-section" style="display: none;">
            <h3>ğŸ“ í˜ì´ì§€ ì œëª© ì„¤ì •</h3>
            <label for="page-title">ìƒì„±ë  ì‹œê°„í‘œ í˜ì´ì§€ ì œëª©:</label>
            <input type="text" id="page-title" placeholder="ì˜ˆ: OOOê³ ë“±í•™êµ 2025ë…„ 1í•™ê¸° êµì‚¬ ì‹œê°„í‘œ">
        </div>

        <div class="logo-upload-section" id="logo-section" style="display: none;">
            <h3>ğŸ« í•™êµ ë¡œê³  ì—…ë¡œë“œ (ì„ íƒ)</h3>
            <div class="logo-upload-box" id="logo-upload-box">
                <div class="logo-preview-container" id="logo-preview-container">
                    <img id="logo-preview" alt="ë¡œê³  ë¯¸ë¦¬ë³´ê¸°">
                    <p>ì—…ë¡œë“œëœ ë¡œê³ </p>
                </div>
                <div class="logo-upload-text">ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”</div>
                <div class="logo-upload-text" style="font-size: 12px; color: #999;">PNG, JPG, GIF ë“± ì§€ì›</div>
            </div>
            <input type="file" id="logo-file-input" accept="image/*">
        </div>

        <button id="generate-button">ê²°ê³¼ HTML íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ</button>
    </div>

<script>
    const uploadBox = document.getElementById('upload-box');
    const fileInput = document.getElementById('file-input');
    const generateButton = document.getElementById('generate-button');
    const statusP = document.getElementById('status');
    const optionsGroup = document.getElementById('options-group');
    const coloringOptionItem = document.getElementById('coloring-option-item');
    const formatbColoringOptionItem = document.getElementById('formatb-coloring-option-item');
    const themeSection = document.getElementById('theme-section');
    const titleSection = document.getElementById('title-section');
    const logoSection = document.getElementById('logo-section');
    const logoUploadBox = document.getElementById('logo-upload-box');
    const logoFileInput = document.getElementById('logo-file-input');
    const logoPreviewContainer = document.getElementById('logo-preview-container');
    const logoPreview = document.getElementById('logo-preview');
    const colorThemeSelect = document.getElementById('color-theme');
    const themePreview = document.getElementById('theme-preview');
    
    let timetableData = null;
    let logoBase64 = null;

    // í…Œë§ˆ ìƒ‰ìƒ ì •ì˜
    const themes = {
        default: {
            primary: '#5A67D8',
            primaryLight: '#7f8ff0',
            background: '#F7FAFC',
            cardBackground: '#FFFFFF',
            textColor: '#2D3748',
            subtleText: '#718096',
            borderColor: '#E2E8F0'
        },
        dark: {
            primary: '#4A5568',
            primaryLight: '#718096',
            background: '#1A202C',
            cardBackground: '#2D3748',
            textColor: '#E2E8F0',
            subtleText: '#A0AEC0',
            borderColor: '#4A5568'
        },
        green: {
            primary: '#38A169',
            primaryLight: '#68D391',
            background: '#F0FFF4',
            cardBackground: '#FFFFFF',
            textColor: '#1A202C',
            subtleText: '#4A5568',
            borderColor: '#C6F6D5'
        },
        purple: {
            primary: '#805AD5',
            primaryLight: '#B794F6',
            background: '#FAF5FF',
            cardBackground: '#FFFFFF',
            textColor: '#1A202C',
            subtleText: '#4A5568',
            borderColor: '#E9D8FD'
        },
        orange: {
            primary: '#DD6B20',
            primaryLight: '#F6AD55',
            background: '#FFFAF0',
            cardBackground: '#FFFFFF',
            textColor: '#1A202C',
            subtleText: '#4A5568',
            borderColor: '#FBD38D'
        },
        teal: {
            primary: '#319795',
            primaryLight: '#4FD1C7',
            background: '#E6FFFA',
            cardBackground: '#FFFFFF',
            textColor: '#1A202C',
            subtleText: '#4A5568',
            borderColor: '#B2F5EA'
        }
    };

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
    uploadBox.addEventListener('click', () => fileInput.click());
    
    uploadBox.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadBox.style.backgroundColor = '#e9ecef';
    });
    uploadBox.addEventListener('dragleave', () => {
        uploadBox.style.backgroundColor = '#f8f9fa';
    });
    uploadBox.addEventListener('drop', (e) => {
        e.preventDefault();
        fileInput.files = e.dataTransfer.files;
        handleFileSelect(fileInput.files[0]);
    });

    fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
    generateButton.addEventListener('click', generateAndDownloadHtml);
    
    // í…Œë§ˆ ì„ íƒ ì´ë²¤íŠ¸
    colorThemeSelect.addEventListener('change', updateThemePreview);
    
    // ë¡œê³  ì—…ë¡œë“œ ì´ë²¤íŠ¸
    logoUploadBox.addEventListener('click', () => logoFileInput.click());
    logoUploadBox.addEventListener('dragover', (e) => {
        e.preventDefault();
        logoUploadBox.style.backgroundColor = '#f0f7ff';
    });
    logoUploadBox.addEventListener('dragleave', () => {
        logoUploadBox.style.backgroundColor = 'white';
    });
    logoUploadBox.addEventListener('drop', (e) => {
        e.preventDefault();
        logoUploadBox.style.backgroundColor = 'white';
        handleLogoSelect(e.dataTransfer.files[0]);
    });
    logoFileInput.addEventListener('change', (e) => handleLogoSelect(e.target.files[0]));
    
    // --- í•¨ìˆ˜ ì •ì˜ ---

    function detectTimetableFormat(data) {
        // Format B ê°ì§€: 3í–‰ì— "ë²ˆí˜¸", "êµì‚¬" ë“±ì´ ìˆê³ , 4í–‰ì— ìˆ«ìê°€ ìˆëŠ” ê²½ìš°
        if (data.length >= 4) {
            const row3 = data[2] || []; // 3í–‰ (0-based index 2)
            const row4 = data[3] || []; // 4í–‰ (0-based index 3)
            
            // Format Bì˜ íŠ¹ì§•: 3í–‰ì— "ë²ˆí˜¸", "êµì‚¬", ìš”ì¼ëª…ì´ ìˆìŒ
            if (row3.includes('ë²ˆí˜¸') && row3.includes('êµì‚¬') && 
                (row3.includes('ì›”') || row3.includes('í™”'))) {
                return 'formatB';
            }
        }
        
        // ê¸°ë³¸ê°’ì€ Format A
        return 'formatA';
    }

    function handleFileSelect(file) {
        if (!file) return;

        statusP.textContent = `âœ… íŒŒì¼ ì„ íƒë¨: ${file.name}`;
        statusP.style.color = '#28a745';
        generateButton.style.display = 'block';
        optionsGroup.style.display = 'block';
        themeSection.style.display = 'block';
        titleSection.style.display = 'block';
        logoSection.style.display = 'block';

        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            
            // ì–‘ì‹ ìœ í˜•ì— ë”°ë¼ ë‹¤ë¥¸ ë²”ìœ„ë¡œ ë°ì´í„° ì½ê¸°
            let jsonData;
            const previewData = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 'A1:Z10' });
            const formatType = detectTimetableFormat(previewData);
            
            if (formatType === 'formatB') {
                // Format B: ì „ì²´ ë°ì´í„° ì½ê¸° (í—¤ë” í¬í•¨)
                jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            } else {
                // Format A: 3í–‰ë¶€í„° ë°ì´í„° ì½ê¸°
                jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 2 });
            }
            
            timetableData = parseTimetable(jsonData);
            // í¬ë§· ì •ë³´ ì €ì¥
            timetableData.formatType = formatType;

            // êµì‹œ êµ¬ì¡° ì •ë³´ í‘œì‹œ
            if (timetableData.length > 0) {
                const structure = timetableData[0];
                const maxPeriods = structure.maxPeriods;
                const periodCounts = structure.periodCounts;
                const formatName = formatType === 'formatB' ? 'ì••í•€ ì–‘ì‹' : 'ì»´ì‹œê°„ì•Œë¦¬ë¯¸ ì–‘ì‹';
                const totalTeachers = timetableData.length;
                
                statusP.innerHTML = `âœ… íŒŒì¼ ë¶„ì„ ì™„ë£Œ: ${file.name}<br><small style="color: #6c757d;">${formatName}ìœ¼ë¡œ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤ | êµì‚¬ ${totalTeachers}ëª… | êµì‹œ êµ¬ì¡°: ì›”(${periodCounts[0]}) í™”(${periodCounts[1]}) ìˆ˜(${periodCounts[2]}) ëª©(${periodCounts[3]}) ê¸ˆ(${periodCounts[4]}) - ìµœëŒ€ ${maxPeriods}êµì‹œ</small>`;
            }

            // ì„ íƒë°˜/ì„ íƒê³¼ëª© í˜•ì‹ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì˜µì…˜ í‘œì‹œ
            if (formatType === 'formatB') {
                // FormatBìš© ì˜µì…˜ë“¤ í‘œì‹œ
                if (checkForSpecialClassesFormatB(timetableData)) {
                    formatbColoringOptionItem.style.display = 'flex';
                } else {
                    formatbColoringOptionItem.style.display = 'none';
                }
                coloringOptionItem.style.display = 'none';
            } else {
                // FormatAìš© ì˜µì…˜ í‘œì‹œ
                if (checkForSpecialClassesFormatA(timetableData)) {
                    coloringOptionItem.style.display = 'flex';
                } else {
                    coloringOptionItem.style.display = 'none';
                }
                formatbColoringOptionItem.style.display = 'none';
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    function handleLogoSelect(file) {
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            logoBase64 = e.target.result;
            logoPreview.src = logoBase64;
            logoPreviewContainer.style.display = 'block';
            logoUploadBox.classList.add('uploaded');
        };
        reader.readAsDataURL(file);
    }

    function updateThemePreview() {
        const selectedTheme = colorThemeSelect.value;
        const theme = themes[selectedTheme];
        
        themePreview.innerHTML = `
            <span class="theme-color" style="background-color: ${theme.primary};" title="ê¸°ë³¸ìƒ‰"></span>
            <span class="theme-color" style="background-color: ${theme.primaryLight};" title="ê°•ì¡°ìƒ‰"></span>
            <span class="theme-color" style="background-color: ${theme.background};" title="ë°°ê²½ìƒ‰"></span>
        `;
    }
    
    function parseTimetable(data) {
        // ì–‘ì‹ ìœ í˜• ìë™ ê°ì§€
        const formatType = detectTimetableFormat(data);
        
        if (formatType === 'formatB') {
            return parseTimetableFormatB(data);
        } else {
            return parseTimetableFormatA(data);
        }
    }

    function parseTimetableFormatA(data) {
        const teachers = [];
        
        // ì²« ë²ˆì§¸ êµì‚¬ì˜ ë°ì´í„°ë¡œ ìš”ì¼ë³„ êµì‹œ ìˆ˜ êµ¬ì¡° íŒŒì•…
        let periodStructure = null;
        if (data.length > 0 && data[0].length > 1) {
            const totalCells = data[0].length - 1; // êµì‚¬ëª… ì œì™¸
            periodStructure = calculatePeriodStructure(totalCells);
        }
        
        if (!periodStructure) {
            // ê¸°ë³¸ê°’ìœ¼ë¡œ í´ë°±
            periodStructure = {
                periodCounts: [7, 7, 7, 6, 6],
                maxPeriods: 7
            };
        }
        
        data.forEach(row => {
            if (!row[0]) return; 

            const teacherName = row[0].replace(/\(\d+\)/, '').trim();
            const scheduleData = row.slice(1);
            
            const schedule = {};
            let currentIndex = 0;
            const daysInOrder = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];

            for (let i = 0; i < daysInOrder.length && i < periodStructure.periodCounts.length; i++) {
                const day = daysInOrder[i];
                const count = periodStructure.periodCounts[i];
                schedule[day] = scheduleData.slice(currentIndex, currentIndex + count).map(cell => cell || '');
                currentIndex += count;
            }
            
            // êµì‚¬ ë°ì´í„°ì— êµì‹œ êµ¬ì¡° ì •ë³´ í¬í•¨
            teachers.push({ 
                name: teacherName, 
                schedule: schedule,
                maxPeriods: periodStructure.maxPeriods,
                periodCounts: periodStructure.periodCounts
            });
        });
        return teachers;
    }

    function parseTimetableFormatB(data) {
        const teachers = [];
        
        // í—¤ë” ë¶„ì„ (3í–‰: ìš”ì¼, 4í–‰: êµì‹œ)
        const dayHeaders = data[2] || [];
        const periodHeaders = data[3] || [];
        
        // ìš”ì¼ë³„ ì»¬ëŸ¼ ë²”ìœ„ ë¶„ì„
        let dayRanges = {};
        let currentDay = '';
        
        for (let i = 2; i < dayHeaders.length; i++) { // 2ë²ˆì§¸ ì»¬ëŸ¼ë¶€í„° (0:ë²ˆí˜¸, 1:êµì‚¬)
            if (dayHeaders[i] && dayHeaders[i] !== null && dayHeaders[i] !== '') {
                if (currentDay && dayRanges[currentDay]) {
                    dayRanges[currentDay].end = i - 1;
                }
                
                currentDay = dayHeaders[i];
                if (currentDay === 'ì›”' || currentDay === 'í™”' || currentDay === 'ìˆ˜' || 
                    currentDay === 'ëª©' || currentDay === 'ê¸ˆ') {
                    dayRanges[currentDay] = { start: i, periods: [] };
                }
            }
            
            if (currentDay && dayRanges[currentDay] && 
                periodHeaders[i] && periodHeaders[i] !== null && periodHeaders[i] !== '') {
                const periodNum = parseInt(periodHeaders[i]);
                if (!isNaN(periodNum)) {
                    dayRanges[currentDay].periods.push({
                        period: periodNum,
                        column: i
                    });
                }
            }
        }
        
        // êµì‹œ êµ¬ì¡° ê³„ì‚°
        const daysInOrder = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
        const periodCounts = daysInOrder.map(day => 
            dayRanges[day] ? dayRanges[day].periods.length : 0
        );
        const maxPeriods = Math.max(...periodCounts, 0);
        
        // ì‹¤ì œ ë°ì´í„° ì‹œì‘ì  ì°¾ê¸° (4í–‰ë¶€í„° êµì‚¬ëª…ì´ ìˆëŠ” í–‰ì„ ì°¾ìŒ)
        let dataStartIndex = 4; // 5í–‰ë¶€í„° ì‹œì‘ (0-based index 4)
        
        // ë°ì´í„° íŒŒì‹± - êµì‚¬ëª…ì´ ìˆëŠ” í–‰ì„ ì°¾ì•„ì„œ ì²˜ë¦¬
        for (let i = dataStartIndex; i < data.length; i++) {
            const currentRow = data[i];
            
            // êµì‚¬ëª…ì´ ìˆëŠ” í–‰ì¸ì§€ í™•ì¸ (1ë²ˆ ì»¬ëŸ¼ì— êµì‚¬ëª…ì´ ìˆì–´ì•¼ í•¨)
            if (!currentRow || !currentRow[1]) continue;
            
            const teacherName = currentRow[1].toString().trim();
            if (!teacherName) continue;
            
            // êµì‚¬ëª…ì´ ìˆ«ìë¡œë§Œ ì´ë£¨ì–´ì ¸ ìˆìœ¼ë©´ ìŠ¤í‚µ (ë²ˆí˜¸ì¼ ê°€ëŠ¥ì„±)
            if (/^\d+$/.test(teacherName)) continue;
            
            // í˜„ì¬ í–‰ì´ ê³¼ëª© í–‰ì¸ì§€ ì¥ì†Œ í–‰ì¸ì§€ í™•ì¸
            // ë‹¤ìŒ í–‰ì„ í™•ì¸í•´ì„œ êµì‚¬ëª…ì´ ê°™ìœ¼ë©´ í˜„ì¬ í–‰ì€ ê³¼ëª©, ë‹¤ìŒ í–‰ì€ ì¥ì†Œ
            const nextRow = data[i + 1];
            let subjectRow = currentRow;
            let locationRow = null;
            
            if (nextRow && nextRow[1] && nextRow[1].toString().trim() === teacherName) {
                // ë‹¤ìŒ í–‰ë„ ê°™ì€ êµì‚¬ëª… -> í˜„ì¬ í–‰ì€ ê³¼ëª©, ë‹¤ìŒ í–‰ì€ ì¥ì†Œ
                locationRow = nextRow;
                i++; // ë‹¤ìŒ í–‰ë„ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ì¸ë±ìŠ¤ ì¦ê°€
            } else if (nextRow && (!nextRow[1] || nextRow[1].toString().trim() === '')) {
                // ë‹¤ìŒ í–‰ì— êµì‚¬ëª…ì´ ì—†ìŒ -> ë‹¤ìŒ í–‰ì´ ì¥ì†Œì¼ ê°€ëŠ¥ì„±
                locationRow = nextRow;
                i++; // ë‹¤ìŒ í–‰ë„ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ì¸ë±ìŠ¤ ì¦ê°€
            }
            // ê·¸ ì™¸ì˜ ê²½ìš°ëŠ” í˜„ì¬ í–‰ì´ ê³¼ëª©ê³¼ ì¥ì†Œê°€ í•©ì³ì§„ í˜•íƒœ
            
            const schedule = {};
            
            daysInOrder.forEach(day => {
                if (dayRanges[day]) {
                    const daySchedule = [];
                    
                    dayRanges[day].periods.forEach(periodInfo => {
                        const subject = subjectRow[periodInfo.column];
                        const location = locationRow ? locationRow[periodInfo.column] : '';
                        
                        let combined = '';
                        if (location && subject) {
                            combined = `${location} ${subject}`;
                        } else if (subject) {
                            combined = subject.toString();
                        } else if (location) {
                            combined = location.toString();
                        }
                        
                        daySchedule.push(combined);
                    });
                    
                    // ë¹ˆ ìŠ¬ë¡¯ìœ¼ë¡œ ìµœëŒ€ êµì‹œ ìˆ˜ë§Œí¼ ì±„ìš°ê¸°
                    while (daySchedule.length < maxPeriods) {
                        daySchedule.push('');
                    }
                    
                    schedule[day] = daySchedule;
                } else {
                    // í•´ë‹¹ ìš”ì¼ ì •ë³´ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´
                    schedule[day] = new Array(maxPeriods).fill('');
                }
            });
            
            teachers.push({
                name: teacherName,
                schedule: schedule,
                maxPeriods: maxPeriods,
                periodCounts: periodCounts
            });
        }
        
        return teachers;
    }

    function calculatePeriodStructure(totalCells) {
        // ì¼ë°˜ì ì¸ í•™êµ ì‹œê°„í‘œ íŒ¨í„´ë“¤ì„ ì‹œë„í•´ë´„
        const commonPatterns = [
            // íŒ¨í„´: [ì›”, í™”, ìˆ˜, ëª©, ê¸ˆ] êµì‹œ ìˆ˜
            [7, 7, 7, 6, 6], // 33êµì‹œ - ê°€ì¥ ì¼ë°˜ì 
            [6, 6, 6, 6, 6], // 30êµì‹œ
            [7, 7, 7, 7, 7], // 35êµì‹œ  
            [8, 8, 8, 6, 6], // 36êµì‹œ
            [8, 8, 8, 7, 7], // 38êµì‹œ
            [8, 8, 8, 8, 8], // 40êµì‹œ
            [5, 5, 5, 5, 5], // 25êµì‹œ - ì´ˆë“±í•™êµ ë“±
            [6, 6, 6, 5, 5], // 28êµì‹œ
            [7, 7, 7, 5, 5]  // 31êµì‹œ
        ];
        
        // ì´ ì…€ ìˆ˜ì™€ ì¼ì¹˜í•˜ëŠ” íŒ¨í„´ ì°¾ê¸°
        for (const pattern of commonPatterns) {
            const sum = pattern.reduce((a, b) => a + b, 0);
            if (sum === totalCells) {
                return {
                    periodCounts: pattern,
                    maxPeriods: Math.max(...pattern)
                };
            }
        }
        
        // íŒ¨í„´ì´ ì—†ìœ¼ë©´ ê· ë“± ë¶„í•  ì‹œë„
        if (totalCells % 5 === 0) {
            const periodsPerDay = totalCells / 5;
            return {
                periodCounts: [periodsPerDay, periodsPerDay, periodsPerDay, periodsPerDay, periodsPerDay],
                maxPeriods: periodsPerDay
            };
        }
        
        // ê·¸ ì™¸ì˜ ê²½ìš° ì¶”ì • ë¡œì§
        return estimatePeriodStructure(totalCells);
    }
    
    function estimatePeriodStructure(totalCells) {
        // ê²½í—˜ì  ì¶”ì •: ì›”~ìˆ˜ëŠ” ê¸´ ìˆ˜ì—…, ëª©~ê¸ˆì€ ì§§ì€ ìˆ˜ì—…ì´ ì¼ë°˜ì 
        let bestPattern = [7, 7, 7, 6, 6]; // ê¸°ë³¸ê°’
        let minDiff = Math.abs(33 - totalCells);
        
        for (let longDays = 5; longDays <= 8; longDays++) {
            for (let shortDaysReduction = 0; shortDaysReduction <= 3; shortDaysReduction++) {
                const shortDays = longDays - shortDaysReduction;
                const pattern = [longDays, longDays, longDays, shortDays, shortDays];
                const sum = pattern.reduce((a, b) => a + b, 0);
                const diff = Math.abs(sum - totalCells);
                
                if (diff < minDiff) {
                    minDiff = diff;
                    bestPattern = pattern;
                }
            }
        }
        
        return {
            periodCounts: bestPattern,
            maxPeriods: Math.max(...bestPattern)
        };
    }

    function checkForSpecialClassesFormatA(data) {
        const pattern = /[A-Z]_/;
        for (const teacher of data) {
            for (const day in teacher.schedule) {
                for (const subject of teacher.schedule[day]) {
                    if (subject && pattern.test(subject)) {
                        return true;
                    }
                }
            }
        }
        return false;
    }

    function checkForSpecialClassesFormatB(data) {
        // FormatBì˜ ì„ íƒê³¼ëª© íŒ¨í„´: ì•ŒíŒŒë²³ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê³¼ëª©ëª… (í•œê¸€ ë˜ëŠ” ì˜ì–´)
        const koreanPattern = /([A-Z])\s?([ê°€-í£])/; // Gí™”í•™, A ê³ ì „ì½ê¸° ë“±
        const englishPattern = /([A-Z])[a-z]+/; // English, Biology ë“±
        
        for (const teacher of data) {
            for (const day in teacher.schedule) {
                for (const subject of teacher.schedule[day]) {
                    if (subject && (koreanPattern.test(subject) || englishPattern.test(subject))) {
                        return true;
                    }
                }
            }
        }
        return false;
    }

    function generateAndDownloadHtml() {
        if (!timetableData) {
            alert("ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
            return;
        }

        const isColoringEnabled = document.getElementById('enable-coloring').checked && coloringOptionItem.style.display !== 'none';
        const isFormatBColoringEnabled = document.getElementById('enable-formatb-coloring').checked && formatbColoringOptionItem.style.display !== 'none';
        const isLineBreakEnabled = document.getElementById('enable-line-break').checked;
        const isLocationChipEnabled = document.getElementById('enable-location-chip').checked;
        const pageTitle = document.getElementById('page-title').value.trim() || 'ê°œì¸ë³„ ì£¼ê°„ ì‹œê°„í‘œ';
        const selectedTheme = colorThemeSelect.value;
        const dataString = JSON.stringify(timetableData);
        const finalHtml = getHtmlTemplate(dataString, isColoringEnabled, isFormatBColoringEnabled, isLineBreakEnabled, isLocationChipEnabled, pageTitle, logoBase64, selectedTheme);
        
        const blob = new Blob([finalHtml], { type: 'text/html;charset=utf-8' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'teacher_timetable_visual.html';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        statusP.textContent = 'ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
    }
    
    function getHtmlTemplate(dataJsonString, isColoringEnabled, isFormatBColoringEnabled, isLineBreakEnabled, isLocationChipEnabled, pageTitle, iconBase64, themeName) {
        const theme = themes[themeName];
        
        return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${pageTitle}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: ${theme.primary};
            --primary-light: ${theme.primaryLight};
            --background-color: ${theme.background};
            --card-background: ${theme.cardBackground};
            --text-color: ${theme.textColor};
            --subtle-text: ${theme.subtleText};
            --border-color: ${theme.borderColor};
        }
        * { box-sizing: border-box; }
        body { 
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0; 
            padding: 20px; 
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
        }
        #app-container { 
            max-width: 1100px; 
            margin: 20px auto; 
            background-color: var(--card-background); 
            padding: 40px; 
            border-radius: 16px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        h1 { 
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color); 
            margin-bottom: 30px; 
            text-align: center; 
            font-size: 2em;
            font-weight: 700;
        }
        .title-icon { 
            height: 2.5em; 
            margin-right: 15px; 
            border-radius: 8px; 
            max-width: 150px; 
            object-fit: contain;
        }
        #search-section { 
            background: ${themeName === 'dark' ? '#4A5568' : '#f8f9fa'};
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 30px; 
        }
        .search-container { position: relative; max-width: 500px; margin: 0 auto; }
        #teacher-search { 
            width: 100%; 
            padding: 15px 20px 15px 50px; 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            font-size: 16px; 
            background-color: var(--card-background); 
            color: var(--text-color);
            transition: all 0.2s ease; 
            outline: none; 
            box-sizing: border-box;
        }
        #teacher-search:focus { 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.3);
        }
        .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--subtle-text); font-size: 20px; }
        .autocomplete-dropdown { position: absolute; top: calc(100% + 5px); left: 0; right: 0; background: var(--card-background); border: 1px solid var(--border-color); border-radius: 12px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .autocomplete-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; color: var(--text-color); }
        .autocomplete-item:hover, .autocomplete-item.selected { background-color: var(--primary-light); color: white; }
        .autocomplete-item:last-child { border-bottom: none; }
        .favorites-section { margin-top: 20px; text-align: center; }
        .favorites-title { font-size: 14px; color: var(--subtle-text); margin-bottom: 12px; }
        .favorite-chips { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .favorite-chip { background: var(--border-color); color: var(--text-color); padding: 8px 14px; border-radius: 20px; font-size: 14px; cursor: pointer; transition: all 0.2s; border: none; font-weight: 500; }
        .favorite-chip:hover { background: var(--primary-color); color: white; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .search-stats { text-align: center; margin: 15px 0; color: var(--subtle-text); font-size: 14px; }
        
        .schedule-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px 0; }
        .teacher-info h2 { margin: 0; color: var(--text-color); font-size: 1.8em; font-weight: 700;}
        .teacher-actions { display: flex; gap: 10px; }
        .action-btn { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border: 1px solid var(--border-color); background: var(--card-background); color: var(--subtle-text); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .action-btn:hover { background: ${themeName === 'dark' ? '#4A5568' : '#f8f9fa'}; color: var(--text-color); border-color: var(--border-color);}
        .action-btn.favorited { background: #FFC107; border-color: #FFC107; color: white; }
        
        /* í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ì¶”ê°€ */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 20px 0; font-size: 15px; table-layout: fixed; }
        th, td { border-bottom: 1px solid var(--border-color); padding: 18px 10px; text-align: center; vertical-align: middle; transition: background-color 0.3s; word-wrap: break-word; }
        th:first-child, td:first-child { width: 15%; }
        th:not(:first-child), td:not(:first-child) { width: 17%; }
        thead th { color: var(--subtle-text); font-weight: 500; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid var(--border-color); background-color: var(--card-background); }
        td:first-child { font-weight: 500; color: var(--text-color); background-color: ${themeName === 'dark' ? '#2D3748' : '#F7FAFC'}; }
        
        /* í…Œì´ë¸” í…Œë‘ë¦¬ ìŠ¤íƒ€ì¼ ê°œì„  */
        tbody tr td:first-child { border-left: 1px solid var(--border-color);}
        tbody tr:first-child td { border-top: 1px solid var(--border-color); }
        tbody td { border-right: 1px solid var(--border-color); background-color: var(--card-background); }
        
        /* ì„ íƒë°˜ íƒœê·¸ ìŠ¤íƒ€ì¼ */
        .subject-tag {
            display: inline-block;
            width: 22px;
            height: 22px;
            line-height: 22px;
            text-align: center;
            border-radius: 50%;
            color: white;
            font-weight: 700;
            font-size: 12px;
            margin-right: 8px;
            vertical-align: middle;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* ìˆ˜ì—…ì¥ì†Œ ì¹© ìŠ¤íƒ€ì¼ */
        .location-chip {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            margin-right: 6px;
            margin-bottom: 2px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .empty-state { text-align: center; padding: 80px 20px; }
        .empty-state-icon { font-size: 5em; margin-bottom: 20px; opacity: 0.5; color: var(--primary-color); }
        .empty-state h3 { font-size: 1.5em; font-weight: 500; color: var(--text-color); }
        .empty-state p { color: var(--subtle-text); }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            body { padding: 10px; }
            #app-container { 
                padding: 20px; 
                margin: 10px auto; 
                border-radius: 12px;
            }
            h1 { 
                font-size: 1.5em; 
                margin-bottom: 20px;
                flex-direction: column;
                gap: 10px;
            }
            .title-icon { 
                margin-right: 0; 
                margin-bottom: 5px;
                height: 2em;
                max-width: 120px;
            }
            
            /* ê²€ìƒ‰ ì„¹ì…˜ ëª¨ë°”ì¼ ìµœì í™” */
            #search-section { 
                padding: 20px 15px; 
                margin-bottom: 20px;
            }
            .search-container { 
                max-width: 100%; 
            }
            #teacher-search { 
                width: 100%;
                padding: 12px 15px 12px 45px; 
                font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
                border-radius: 8px;
                box-sizing: border-box;
            }
            .search-icon { 
                left: 15px; 
            }
            
            /* ì¦ê²¨ì°¾ê¸° ì¹© ëª¨ë°”ì¼ ìµœì í™” */
            .favorite-chips { 
                gap: 8px; 
                justify-content: flex-start;
                flex-wrap: wrap;
            }
            .favorite-chip { 
                padding: 6px 12px; 
                font-size: 13px;
                white-space: nowrap;
            }
            
            /* ìŠ¤ì¼€ì¤„ í—¤ë” ëª¨ë°”ì¼ ìµœì í™” */
            .schedule-header { 
                flex-direction: column; 
                gap: 15px; 
                align-items: flex-start;
                margin-bottom: 15px;
            }
            .teacher-info h2 { 
                font-size: 1.4em; 
                text-align: center;
                width: 100%;
            }
            .teacher-actions { 
                width: 100%; 
                display: flex; 
                gap: 10px;
                flex-wrap: wrap;
            }
            .action-btn { 
                flex: 1; 
                min-width: 120px;
                padding: 10px 12px;
                font-size: 14px;
                justify-content: center;
            }
            
            /* í…Œì´ë¸” ëª¨ë°”ì¼ ìµœì í™” */
            table { 
                font-size: 12px; 
                border-radius: 8px;
                overflow: hidden;
            }
            th, td { 
                padding: 8px 4px; 
                line-height: 1.3;
            }
            td { 
                height: 50px; 
                min-height: 50px;
            }
            td small { 
                font-size: 10px; 
                display: block;
                margin-top: 2px;
            }
            
            /* êµì‹œ ì—´ ê³ ì • */
            th:first-child, td:first-child {
                position: sticky;
                left: 0;
                background: var(--card-background);
                z-index: 1;
                box-shadow: 2px 0 4px rgba(0,0,0,0.1);
                min-width: 50px;
            }
            
            /* ë¹ˆ ìƒíƒœ ëª¨ë°”ì¼ ìµœì í™” */
            .empty-state { 
                padding: 60px 20px; 
            }
            .empty-state-icon { 
                font-size: 3em; 
            }
            .empty-state h3 {
                font-size: 1.2em;
                margin-top: 15px;
            }
            
            /* ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ ëª¨ë°”ì¼ ìµœì í™” */
            .autocomplete-dropdown {
                max-height: 150px;
                border-radius: 8px;
            }
            .autocomplete-item {
                padding: 15px 20px;
                font-size: 14px;
                border-bottom: 1px solid var(--border-color);
            }
        }
        
        /* ì‘ì€ ëª¨ë°”ì¼ í™”ë©´ */
        @media (max-width: 480px) {
            #app-container { 
                padding: 15px; 
                margin: 5px auto;
            }
            h1 { 
                font-size: 1.3em; 
            }
            .title-icon { 
                height: 1.8em;
                max-width: 100px;
            }
            table { 
                font-size: 11px; 
            }
            th, td { 
                padding: 6px 3px; 
            }
            td { 
                height: 45px; 
                min-height: 45px;
            }
            .teacher-info h2 { 
                font-size: 1.2em; 
            }
            .action-btn {
                font-size: 13px;
                padding: 8px 10px;
            }
        }

        @media print {
            body { background: white; padding: 0; margin: 0; }
            #app-container { box-shadow: none; padding: 15px; margin: 0; max-width: 100%; }
            #search-section { display: none; }
            h1 { display: none; }
            .teacher-actions { display: none; }
            .schedule-header { margin-bottom: 10px; text-align: center; }
            .teacher-info h2 { font-size: 9pt; margin: 0; font-weight: bold; }
            table { 
                font-size: 9pt; 
                margin: 0 auto;
                width: 75%;
                max-width: 600px;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                page-break-inside: avoid;
            }
            td, th { 
                padding: 6px 4px; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                line-height: 1.2;
            }
            .location-chip { 
                font-size: 8px;
                padding: 2px 5px;
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
            .subject-tag { 
                width: 16px;
                height: 16px;
                line-height: 16px;
                font-size: 8px;
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
            @page {
                size: A4;
                margin: 15mm;
            }
            * {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <h1>
            ${iconBase64 ? `<img src="${iconBase64}" alt="logo" class="title-icon">` : 'ğŸ“…'}
            <span>${pageTitle}</span>
        </h1>
        <div id="search-section">
            <div class="search-container">
                <div class="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <input type="text" id="teacher-search" placeholder="êµì‚¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”...">
                <div class="autocomplete-dropdown" id="autocomplete-dropdown"></div>
            </div>
            <div class="search-stats" id="search-stats"></div>
            <div class="favorites-section">
                <div class="favorites-title">ìì£¼ ì°¾ëŠ” êµì‚¬</div>
                <div class="favorite-chips" id="favorite-chips"></div>
            </div>
        </div>
        <div id="schedule-container">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ‘¨â€ğŸ«</div>
                <h3>ì‹œê°„í‘œë¥¼ í™•ì¸í•˜ê³  ì‹¶ì€ êµì‚¬ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”</h3>
                <p>ì´ë¦„ì„ ì…ë ¥í•˜ì‹œë©´ ìë™ìœ¼ë¡œ ëª©ë¡ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</p>
            </div>
        </div>
    </div>
    <script>
        const allSchedules = ${dataJsonString};
        const isColoringEnabled = ${isColoringEnabled};
        const isFormatBColoringEnabled = ${isFormatBColoringEnabled};
        const isLineBreakEnabled = ${isLineBreakEnabled};
        const isLocationChipEnabled = ${isLocationChipEnabled};

        const teacherSearchInput = document.getElementById('teacher-search');
        const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
        const scheduleContainer = document.getElementById('schedule-container');
        const searchStats = document.getElementById('search-stats');
        const favoriteChips = document.getElementById('favorite-chips');

        let filteredTeachers = [...allSchedules];
        let selectedIndex = -1;
        let favorites = JSON.parse(localStorage.getItem('favTeachers') || '[]');
        
        // --- Helper Functions ---
        function stringToHslColor(str, s, l) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = hash % 360;
            return 'hsl(' + h + ', ' + s + '%, ' + l + '%)';
        }
        
        /**
         * BUG FIX: This function has been rewritten to correctly handle subject formatting.
         * The new logic separates location and subject first, then applies formatting,
         * and finally combines them. This fixes issues where HTML tags from location
         * chips interfered with subject pattern matching.
         */
        function processSubject(subject) {
            if (!subject) return { html: '', style: '' };

            const subjectStr = subject.toString();
            let location = '';
            let subjectName = subjectStr;
            let cellBorderStyle = '';

            // Step 1: Separate location from subject name.
            // Assumes location is a single word at the beginning.
            const match = subjectStr.match(/^(\\S+)\\s+(.+)$/);
            
            // Heuristic to prevent "A_Subject" from being incorrectly split
            const isFormatAStyle = match && /^[A-Z]_/.test(match[1]);

            if (match && !isFormatAStyle) {
                location = match[1];
                subjectName = match[2];
            }

            // Step 2: Process the subjectName for special formatting (tags, colors).
            let processedSubjectName = subjectName;

            // Format A: A_ê³¼ëª©
            if (isColoringEnabled) { 
                const specialPattern = /^([A-Z])_(\\S+)/;
                const spMatch = subjectName.match(specialPattern);
                if (spMatch) {
                    const letter = spMatch[1];
                    const rest = spMatch[2];
                    const color = stringToHslColor(letter, 60, 55);
                    cellBorderStyle = \`border-left: 5px solid \${color};\`;
                    const tagHtml = \`<span class="subject-tag" style="background-color: \${color};">\${letter}</span>\`;
                    processedSubjectName = tagHtml + rest;
                }
            }
            
            // Format B: Gí™”í•™, English
            if (isFormatBColoringEnabled) { 
                // Pattern for "G í™”í•™" or "Gí™”í•™"
                const koreanPattern = /^([A-Z])\\s?([ê°€-í£].*)$/; 
                const koreanMatch = subjectName.match(koreanPattern);

                // Pattern for "English" (whole word)
                const englishPattern = /^([A-Z][a-z]+)$/; 
                const englishMatch = subjectName.match(englishPattern);

                if (koreanMatch) {
                    const letter = koreanMatch[1];
                    const rest = koreanMatch[2];
                    const color = stringToHslColor(letter, 60, 55);
                    cellBorderStyle = \`border-left: 5px solid \${color};\`;
                    const tagHtml = \`<span class="subject-tag" style="background-color: \${color};">\${letter}</span>\`;
                    processedSubjectName = tagHtml + rest;
                } else if (englishMatch) {
                    const letter = englishMatch[0].charAt(0);
                    const color = stringToHslColor(letter, 60, 55);
                    cellBorderStyle = \`border-left: 5px solid \${color};\`;
                    const tagHtml = \`<span class="subject-tag" style="background-color: \${color};">\${letter}</span>\`;
                    processedSubjectName = tagHtml + subjectName.substring(1);
                }
            }

            // Step 3: Process the location for chip formatting.
            let locationHtml = '';
            if (location) {
                if (isLocationChipEnabled) {
                    const locationColor = stringToHslColor(location, 65, 50);
                    locationHtml = \`<span class="location-chip" style="background-color: \${locationColor};">\${location}</span>\`;
                } else {
                    locationHtml = location; // Just text
                }
            }

            // Step 4: Combine location and subject with line breaks.
            let finalHtml;
            if (locationHtml) {
                if (isLineBreakEnabled) {
                    finalHtml = \`\${locationHtml}<br>\${processedSubjectName}\`;
                } else {
                    finalHtml = \`\${locationHtml} \${processedSubjectName}\`;
                }
            } else {
                finalHtml = processedSubjectName; // No location, just the processed subject
            }

            return { html: finalHtml, style: cellBorderStyle };
        }


        // --- Main Functions ---
        function init() {
            updateSearchStats();
            updateFavoriteChips();
            setupEventListeners();
        }

        function setupEventListeners() {
            teacherSearchInput.addEventListener('input', handleSearch);
            teacherSearchInput.addEventListener('keydown', handleKeyNavigation);
            teacherSearchInput.addEventListener('focus', showDropdown);
            document.addEventListener('click', handleClickOutside);
        }

        function handleSearch(e) {
            const query = e.target.value.trim().toLowerCase();
            if (query === '') {
                filteredTeachers = [...allSchedules];
                hideDropdown();
                showEmptyState();
            } else {
                filteredTeachers = allSchedules.filter(teacher => teacher.name.toLowerCase().includes(query));
                updateAutocomplete();
            }
            updateSearchStats();
        }

        function handleKeyNavigation(e) {
            const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
            if (!items.length) return;

            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection(items);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    updateSelection(items);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedIndex >= 0 && items[selectedIndex]) {
                        selectTeacher(filteredTeachers[selectedIndex].name);
                    } else if (filteredTeachers.length > 0) {
                        selectTeacher(filteredTeachers[0].name);
                    }
                    break;
                case 'Escape':
                    hideDropdown();
                    break;
            }
        }

        function updateSelection(items) {
            items.forEach((item, index) => item.classList.toggle('selected', index === selectedIndex));
        }

        function updateAutocomplete() {
            if (filteredTeachers.length === 0) {
                hideDropdown();
                return;
            }
            autocompleteDropdown.innerHTML = filteredTeachers.map(teacher => {
                const isFavorite = favorites.includes(teacher.name);
                return \`<div class="autocomplete-item" onclick="selectTeacher('\${teacher.name}')">\${isFavorite ? 'â­ ' : ''}\${teacher.name}</div>\`;
            }).join('');
            showDropdown();
            selectedIndex = -1;
        }

        function selectTeacher(teacherName) {
            teacherSearchInput.value = teacherName;
            hideDropdown();
            displaySchedule(teacherName);
        }

        function displaySchedule(teacherName) {
            const teacher = allSchedules.find(t => t.name === teacherName);
            if (!teacher) {
                scheduleContainer.innerHTML = '<div class="empty-state"><h3>í•´ë‹¹ êµì‚¬ì˜ ì‹œê°„í‘œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</h3></div>';
                return;
            }
            
            const isFavorite = favorites.includes(teacherName);
            const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
            const maxPeriods = teacher.maxPeriods || 7; // ë™ì  êµì‹œ ìˆ˜ ì‚¬ìš©
            const periodCounts = teacher.periodCounts || [7, 7, 7, 6, 6]; // ìš”ì¼ë³„ êµì‹œ ìˆ˜
            
            let tableHTML = \`
                <div class="schedule-header">
                    <div class="teacher-info"><h2>\${teacher.name} ì„ ìƒë‹˜ ì‹œê°„í‘œ</h2></div>
                    <div class="teacher-actions">
                        <button class="action-btn \${isFavorite ? 'favorited' : ''}" onclick="toggleFavorite('\${teacherName}')">
                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="\${isFavorite ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                            <span>\${isFavorite ? 'ì¦ê²¨ì°¾ê¸°ë¨' : 'ì¦ê²¨ì°¾ê¸°'}</span>
                        </button>
                        <button class="action-btn" onclick="printSchedule()">
                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                            <span>ì¸ì‡„</span>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                <table>
                    <thead><tr><th>êµì‹œ</th><th>ì›”ìš”ì¼</th><th>í™”ìš”ì¼</th><th>ìˆ˜ìš”ì¼</th><th>ëª©ìš”ì¼</th><th>ê¸ˆìš”ì¼</th></tr></thead>
                    <tbody>\`;

            for (let i = 0; i < maxPeriods; i++) {
                tableHTML += \`<tr><td>\${i + 1}êµì‹œ</td>\`;
                days.forEach((day, dayIndex) => {
                    // í•´ë‹¹ ìš”ì¼ì˜ êµì‹œ ìˆ˜ë¥¼ í™•ì¸í•´ì„œ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ë§Œ í‘œì‹œ
                    if (i < periodCounts[dayIndex] && teacher.schedule[day] && teacher.schedule[day][i]) {
                        const subjectInfo = processSubject(teacher.schedule[day][i]);
                        tableHTML += \`<td style="\${subjectInfo.style}">\${subjectInfo.html}</td>\`;
                    } else {
                        // í•´ë‹¹ ìš”ì¼ì— ì´ êµì‹œê°€ ì—†ìœ¼ë©´ ë¹ˆ ì…€
                        tableHTML += \`<td style="background-color: var(--border-color); color: var(--subtle-text);">-</td>\`;
                    }
                });
                tableHTML += '</tr>';
            }
            
            tableHTML += '</tbody></table></div>';
            scheduleContainer.innerHTML = tableHTML;
        }

        function toggleFavorite(teacherName) {
            const index = favorites.indexOf(teacherName);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(teacherName);
            }
            localStorage.setItem('favTeachers', JSON.stringify(favorites));
            updateFavoriteChips();
            displaySchedule(teacherName);
        }

        function updateFavoriteChips() {
            if (favorites.length === 0) {
                favoriteChips.innerHTML = '<span style="color: var(--subtle-text); font-size: 13px;">ì•„ì§ ì¦ê²¨ì°¾ê¸°í•œ êµì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</span>';
                return;
            }
            favoriteChips.innerHTML = favorites.map(name => \`<button class="favorite-chip" onclick="selectTeacher('\${name}')">\${name}</button>\`).join('');
        }

        function updateSearchStats() {
            const total = allSchedules.length;
            const filtered = filteredTeachers.length;
            if (teacherSearchInput.value.trim() === '') {
                searchStats.textContent = \`ì´ \${total}ëª…ì˜ êµì‚¬\`;
            } else {
                searchStats.textContent = \`\${filtered}ëª…ì˜ êµì‚¬ê°€ ê²€ìƒ‰ë¨ (ì „ì²´ \${total}ëª…)\`;
            }
        }

        function showDropdown() {
            if (filteredTeachers.length > 0 && teacherSearchInput.value.trim() !== '') {
                autocompleteDropdown.style.display = 'block';
            }
        }

        function hideDropdown() {
            autocompleteDropdown.style.display = 'none';
            selectedIndex = -1;
        }

        function handleClickOutside(e) {
            if (!e.target.closest('.search-container')) {
                hideDropdown();
            }
        }

        function showEmptyState() {
            scheduleContainer.innerHTML = \`
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘¨â€ğŸ«</div>
                    <h3>ì‹œê°„í‘œë¥¼ í™•ì¸í•˜ê³  ì‹¶ì€ êµì‚¬ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”</h3>
                    <p>ì´ë¦„ì„ ì…ë ¥í•˜ì‹œë©´ ìë™ìœ¼ë¡œ ëª©ë¡ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</p>
                </div>\`;
        }

        function printSchedule() {
            window.print();
        }

        init();
    <\/script>
</body>
</html>
        `;
    }

    // ì´ˆê¸° í…Œë§ˆ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    updateThemePreview();
</script>
</body>
</html>
